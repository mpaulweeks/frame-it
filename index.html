<html>
<head>
  <title>Frame-It!</title>
  <link rel="shortcut icon" href="favicon.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body {
      width: 100%;
      margin: 0 auto;
      font-size: 20px;
    }
    button, select {
      border: 1px solid black;
      font-size: 1rem;
      cursor: pointer;
      color: black;
      background-color: white;
    }
    button:hover, select:hover {
      color: white;
      background-color: black;
      cursor: pointer;
    }
    input {
      display: none;
    }
    .row {
      width: 100%;
      padding: 5px;
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      justify-content: center;
    }
    .column {
      padding: 0px 10px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .title {
      font-size: 24pt;
    }

    #download-link {
      display: none;
    }

    #canvas {
      margin: 0px auto;
    }
    @media (max-width: 400px){
      .column {
        text-align: center;
        width: 100%;
        padding-bottom: 10px;
      }
    }
  </style>
<body>
  <div class="row">
    <div class="title">
      Frame-It!
    </div>
  </div>

  <!-- interactive panel -->
  <div class="row">
    <div class="column">
      <div>
        <button id="upload-feature-button">Upload Image</button>
        <input id="upload-feature" type="file"/>
      </div>
    </div>
    <div class="column">
      <div>
        <label>
          Select Background
          <select id="background-select">
            <!-- filled via JS -->
          </select>
        </label>
      </div>
    </div>
    <div class="column">
      <div>
        <button id="save-button">Download Framed</button>
      </div>
    </div>
  </div>

  <!-- canvas -->
  <div class="row">
    <canvas id="canvas"></canvas>
  </div>

  <!-- hidden download link -->
  <a id="download-link" download="framed.png"></a>

  <script>

    const elmBackgrounds = document.getElementById('background-select');
    const elmUploadFeatureButton = document.getElementById('upload-feature-button');
    const elmUploadFeature = document.getElementById('upload-feature');
    const elmSaveButton = document.getElementById('save-button');
    const elmSaveLink = document.getElementById("download-link");
    const elmCanvas = document.getElementById("canvas");
    const ctx = elmCanvas.getContext("2d");
    const imgBackground = new Image();
    const imgFeature = new Image();

    const backgrounds = [
      {
        source: 'background/dark.png',
        name: 'Dark',
      },
      {
        source: 'background/clouds.jpg',
        name: 'Clouds',
      },
    ];
    backgrounds.forEach((bg, bid) => {
      elmBackgrounds.innerHTML += `<option value="${bid}">${bg.name}</option>`;
    });
    let currentBackground = null;

    const frameParts = [
      'bottom_left',
      'bottom_right',
      'middle_left',
      'top_left',
      'top_right',
      'bottom_middle',
      'filler_bottom',
      'filler_left',
      'filler_right',
      'filler_top',
      'middle_right',
      'top_middle',
    ].reduce((obj, name) => {
      const img = new Image();
      img.onload = paint;
      img.src = `frames/${name}.png`;
      obj[name] = img;
      return obj;
    }, {});


    const frameSize = 0.5;
    function loadBackground(backgroundId){
      currentFrame = backgrounds[backgroundId];
      imgBackground.src = currentFrame.source;
    }
    function paintFrame(frameImg, x, y){
      const width = frameImg.width * frameSize;
      const height = frameImg.height * frameSize;
      ctx.drawImage(
        frameImg,
        x - (width / 2),
        y - (height / 2),
        width,
        height
      );
    }
    function paint() {
      if (!frameParts.filler_top.width){
        return;
      }

      const fillerSize = frameParts.filler_top.width * frameSize;
      const bufferPage = 50;
      const bufferBackground = fillerSize * 10;

      // set bg
      const windowWidth = document.body.clientWidth - bufferPage;
      const canvasWidth = Math.min(windowWidth, imgBackground.width);
      const canvasHeight = imgBackground.height * (canvasWidth / imgBackground.width);
      elmCanvas.width = canvasWidth;
      elmCanvas.height = canvasHeight;
      ctx.drawImage(imgBackground, 0, 0, canvasWidth, canvasHeight);

      // set featureed image
      let featureHeight = Math.min(canvasHeight - bufferBackground, imgFeature.height);
      let featureWidth = imgFeature.width * (featureHeight / imgFeature.height);
      if (featureWidth > canvasWidth - bufferBackground) {
        featureWidth = canvasWidth - bufferBackground;
        featureHeight = imgFeature.height * (featureWidth / imgFeature.width);
      }
      const borderTop = (canvasHeight / 2) - (featureHeight / 2);
      const borderBottom = borderTop + featureHeight;
      const borderCenterVertical = borderTop + (featureHeight / 2);
      const borderLeft = (canvasWidth / 2) - (featureWidth / 2);
      const borderRight = borderLeft + featureWidth;
      const borderCenterHorizontal = borderLeft + (featureWidth / 2);
      ctx.drawImage(
        imgFeature,
        borderLeft,
        borderTop,
        featureWidth,
        featureHeight
      );

      // frame filler
      if (frameParts.filler_top.width){
        const fillerSize = frameParts.filler_top.width * frameSize;
        for (let x = borderLeft; x < borderRight; x += fillerSize){
          paintFrame(frameParts.filler_top, x, borderTop);
          paintFrame(frameParts.filler_bottom, x, borderBottom);
        }
        for (let y = borderTop; y < borderBottom; y += fillerSize){
          paintFrame(frameParts.filler_left, borderLeft, y);
          paintFrame(frameParts.filler_right, borderRight, y);
        }
      }

      // frame sides
      paintFrame(frameParts.middle_left, borderLeft, borderCenterVertical);
      paintFrame(frameParts.middle_right, borderRight, borderCenterVertical);
      paintFrame(frameParts.top_middle, borderCenterHorizontal, borderTop);
      paintFrame(frameParts.bottom_middle, borderCenterHorizontal, borderBottom);

      // frame corners
      paintFrame(frameParts.top_left, borderLeft, borderTop);
      paintFrame(frameParts.top_right, borderRight, borderTop);
      paintFrame(frameParts.bottom_left, borderLeft, borderBottom);
      paintFrame(frameParts.bottom_right, borderRight, borderBottom);
    }
    imgFeature.onload = paint;
    imgBackground.onload = paint;

    elmBackgrounds.addEventListener('change', e => {
      const backgroundId = parseFloat(e.target.value);
      loadBackground(backgroundId);
    });
    elmUploadFeatureButton.addEventListener('click', e => {
      elmUploadFeature.click();
    });
    elmUploadFeature.addEventListener('change', e1 => {
      const reader = new FileReader;
      reader.onload = e2 => {
        const source = e2.target.result;
        imgFeature.src = source;
      };
      reader.readAsDataURL(e1.target.files[0]);
    }, false);
    elmSaveButton.addEventListener('click', () => {
      const dt = elmCanvas.toDataURL("image/png");
      elmSaveLink.href = dt;
      elmSaveLink.click();
    });
    window.addEventListener("resize", paint);

    // default image and frame
    imgFeature.src = 'example/joseph.jpg';
    loadBackground(0);

  </script>
</body>
</html>
